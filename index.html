<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy Birthday! üéâ</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2,#f093fb);display:flex;align-items:center;justify-content:center;padding:20px;}
  /* make overall page safe for small screens */
  body { overflow-x:hidden; }

  /* ---------- Envelope (responsive: option A - same layout scaled) ---------- */
  #envelope {
    width: min(540px, 86vw);
    aspect-ratio: 16 / 10; /* keeps proportions across devices */
    max-width: 700px;
    position: relative;
    perspective: 1200px;
    cursor: pointer;
    z-index: 1200;
  }

  /* envelope back (paper inside sits above it) */
  .env-back {
    position:absolute; inset:0;
    background: linear-gradient(145deg,#ffffff 0%,#f3f3f3 100%);
    border-radius:12px;
    border:2px solid rgba(0,0,0,0.06);
    box-shadow: 0 20px 50px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.6);
    z-index:1;
    overflow:hidden;
  }

  /* inside paper (will slide up) */
  .env-paper {
    position:absolute;
    left:8%;
    width:84%;
    height:65%;
    bottom:30%;
    background: #fff ;
    border-radius:6px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#777;
    font-weight:700;
    /* keep paper behind the envelope back until opened */
    z-index:0;
    transform: translateY(28%);
    transition: transform 900ms cubic-bezier(.2,.9,.25,1);
    padding:14px;
    text-align:center;
    pointer-events:none;
  }

  /* top flap (triangle) - use a clipped rectangle so we can position the OPEN badge reliably */
  .env-flap {
    position:absolute;
    left:0; right:0; top:0; margin:0 auto;
    width:100%;
    height:46%;
    border-radius: 12px 12px 0 0;
    background: linear-gradient(180deg,#ff99c9 0%, #ff69b4 100%);
    clip-path: polygon(0 0, 50% 100%, 100% 0);
    transform-origin: top center;
    z-index:5;
    box-shadow: 0 8px 18px rgba(0,0,0,0.18);
    transition: transform 900ms cubic-bezier(.2,.9,.25,1), opacity 600ms ease;
  }

  /* hide the old pseudo label if present */
  .env-flap::after { display:none; }

  /* centered badge that reads OPEN */
  .open-badge {
    position:absolute;
    left:50%; top:50%; transform:translate(-50%,-8%);
    background:#fff; color:#ff4f9a; font-weight:900; letter-spacing:1px;
    padding:6px 14px; border-radius:10px; z-index:6;
    box-shadow: 0 8px 18px rgba(0,0,0,0.22);
    font-size:clamp(12px,1.6vw,18px);
    pointer-events:none;
  }

  /* hint text shown in front of the envelope so user knows to click */
  .open-hint {
    position:absolute;
    left:50%; top:120%; transform:translate(-50%,-50%);
    color:#444; font-size:14px; z-index:7; font-weight:700; letter-spacing:0.2px;
    background: rgba(255,255,255,0.92); padding:8px 14px; border-radius:8px; box-shadow:0 6px 16px rgba(0,0,0,0.12);
    pointer-events:none;
  }

  /* envelope opened state */
  #envelope.open .env-flap {
    transform: translateY(-5%) rotateX(-200deg) translateZ(14px);
    opacity:0;
  }
  /* when opened, bring the paper above the back so it becomes visible */
  #envelope.open .env-paper { z-index:4; }
  /* hide the open badge and hint only after a short delay ‚Äî controlled by JS adding `hide-overlays` */
  #envelope.open.hide-overlays .open-badge,
  #envelope.open.hide-overlays .open-hint { opacity:0; transform:translate(-50%,-8%) scale(.9); transition:opacity 260ms ease, transform 260ms ease; }
  /* slide paper up and a little forward when opened */
  #envelope.open .env-paper {
    transform: translateY(-140%) translateZ(20px) rotateX(0deg);
  }

  /* small crease to make envelope realistic */
  #envelope::after{
    content:'';position:absolute;left:50%;top:0; transform:translateX(-50%);
    width:2px;height:100%; background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02) 50%, transparent);
    z-index:8; pointer-events:none;
  }

  /* ---------- After opening: main container (hidden until open) ---------- */
  .container {
    width: min(720px, 92vw);
    max-width: 950px;
    background: rgba(255,255,255,0.98);
    border-radius:16px;
    padding:28px;
    box-shadow: 0 24px 80px rgba(0,0,0,0.28);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    z-index:1100;
    transform-origin:center;
  }

  .container.hidden { display:none; }

  .emoji { font-size:56px; animation:bounce 1.6s infinite; }
  @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-16px)} }

  .greeting { font-size:clamp(28px,4.2vw,48px); font-weight:800; background:linear-gradient(135deg,#667eea,#764ba2,#f093fb); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-align:center; margin-top:2px;}
  .name-display { font-size:clamp(20px,3.2vw,40px); color:#ff69b4; font-weight:800; margin-top:-2px; font-family: 'Comic Sans MS', cursive, sans-serif; }

  .lyrics-display {
    width:100%;
    max-width:820px;
    min-height:96px;
    background: rgba(250,250,250,0.9);
    border-radius:10px;
    padding:12px 18px;
    text-align:center;
    font-size:clamp(14px,2.2vw,20px);
    color:#222;
    line-height:1.4;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
  }

  .lyric-line { display:block; opacity:0; transform:translateY(8px); transition:all 260ms ease; white-space:pre-wrap; }
  .lyric-line.visible { opacity:1; transform:translateY(0); }

  .message { font-size:clamp(14px,2vw,18px); color:#444; font-style:italic; text-align:center; display:none; margin:6px 0; max-width:84%; }

  #celebrateBtn { padding:12px 34px; border-radius:40px; border:none; background:linear-gradient(135deg,#f093fb,#f5576c); color:#fff; font-weight:800; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,0.18); font-size:clamp(14px,2vw,18px); }

  /* confetti pieces */
  .confetti { position:fixed; width:10px;height:10px; pointer-events:none; border-radius:2px; z-index:1500;}

  /* balloons */
  .balloon { position:fixed; width:48px;height:62px; border-radius:50% 50% 60% 60%; pointer-events:none; display:flex; align-items:flex-end; justify-content:center; transform-origin:center bottom; z-index:1400; }
  .balloon .string { position:absolute; bottom:-70px; width:2px; height:70px; background:#333; left:50%; transform:translateX(-50%); transform-origin:top center; animation:stringWiggle 1.6s ease-in-out infinite; border-radius:1px; opacity:0.95; }
  @keyframes stringWiggle { 0%{transform:translateX(-50%) rotate(-7deg)} 50%{transform:translateX(-50%) rotate(7deg)} 100%{transform:translateX(-50%) rotate(-7deg)} }

  /* floating image */
  .floating-pic { position:fixed; width:140px; height:140px; border-radius:12px; object-fit:cover; box-shadow:0 12px 30px rgba(0,0,0,0.22); z-index:1400; animation: floatEntrance 8s linear forwards; }
  @keyframes floatEntrance { 0%{transform:translateY(120vh) rotate(0deg) scale(.85); opacity:0} 6%{opacity:1} 90%{opacity:1} 100%{transform:translateY(-100px) rotate(360deg) scale(1); opacity:0} }

  /* fireworks canvas (keeps transparent) */
  canvas { position:fixed;left:0;top:0;width:100%;height:100%; pointer-events:none; z-index:-1; }

  /* small screens tweaks (Option A: same layout scaled) */
  @media (max-width:520px){
    #envelope { width: min(92vw,420px); aspect-ratio: 16/10; }
    .env-paper { left:4%; width:92%; height:80%; }
    .container { padding:20px; gap:8px;}
    .lyrics-display { min-height:84px; font-size:14px; }
    .floating-pic { width:100px; height:100px; }
    .name-display { font-size:20px; }
    .greeting { font-size:26px; }
  }
</style>
</head>
<body>

  <!-- Envelope overlay (click to open) -->
  <div id="envelope" aria-label="Open envelope">
    <div class="env-back"></div>
    <div class="env-paper" id="envPaper"></div>
    <div class="env-flap"></div>
    <div class="open-badge" aria-hidden="true">OPEN</div>
    <div class="open-hint" aria-hidden="true">üéÅ Open to see the surprise!</div>
  </div>

  <!-- visual layer -->
  <canvas id="fireworksCanvas"></canvas>
  <div id="flash" style="position:fixed;left:0;top:0;width:100%;height:100%;background:#fff;opacity:0;pointer-events:none;z-index:1600"></div>

  <!-- main greeting container (hidden until envelope opens) -->
  <div class="container hidden" id="mainContainer" role="region" aria-label="Birthday message">
    <div class="emoji">üéÇ</div>
    <h1 class="greeting" id="greetingText">Happy 18th Birthday!</h1>
    <h2 class="name-display" id="nameDisplay">Neomi</h2>

    <div class="lyrics-display" id="lyricsDisplay" aria-live="polite" aria-atomic="true">
      <div id="lyricLine" class="lyric-line"></div>
    </div>

    <p class="message" id="wishMessage">
      May your life be filled with good health and bright opportunities. Keep growing, stay true to yourself, and may every year bring you wisdom and kindness. üéâ
    </p>

    <button id="celebrateBtn" onclick="startCelebration()">üéâ Celebrate!</button>
  </div>

<script>
/* ---------------- audio file (uploaded) ---------------- */
const AUDIO_SRC = 'Just The Way You Are - Bruno Mars.mp3';

/* ---------------- basic UX: open envelope reveal paper slide & show container ---------------- */
const envelope = document.getElementById('envelope');
const mainContainer = document.getElementById('mainContainer');
const envPaper = document.getElementById('envPaper');
const flashEl = document.getElementById('flash');

envelope.addEventListener('click', () => {
  // flip flap and slide paper out
  envelope.classList.add('open');
  // keep hint/badge visible while flap animation plays, then hide overlays
  setTimeout(() => envelope.classList.add('hide-overlays'), 900);

  // hide the envelope completely after animation
  setTimeout(() => {
    envelope.style.opacity = "0";
    envelope.style.pointerEvents = "none";
    // remove from layout so the main container can be centered
    envelope.style.display = 'none';
  }, 1000);

  // flash and show container after paper slides
  setTimeout(()=> {
    // reveal the main container
    mainContainer.classList.remove('hidden');

    // flash effect
    flashEl.style.transition = 'opacity 220ms ease';
    flashEl.style.opacity = '0.9';
    setTimeout(()=> flashEl.style.opacity = '0', 200);

    // auto-start celebration sequence
    startCelebration();
  }, 900); // match envelope animation 
});


/* -------------- Lyrics timeline (times in seconds) -------------- */
/* singing begins around 17s in file; first 'OH...' is intro at 0s */
const lyricsTimeline = [
  { t: 0.0, duration: 5.5, text: "OH, OH-OH-OH\nOH-OH-OH-OH\nOH-OH-OH" },
  { t: 17.0, duration: 5.5, text: "Oh, her eyes, her eyes\nMake the stars look like they're not shinin'" },
  { t: 22.5, duration: 4.5, text: "Her hair, her hair\nFalls perfectly without her tryin'" },
  { t: 27.0, duration: 7.0, text: "She's so beautiful\nAnd I tell her every day" },
  { t: 34.0, duration: 6.0, text: "Yeah, I know, I know\nWhen I compliment her, she won't believe me" },
  { t: 40.0, duration: 4.5, text: "And it's so, it's so\nSad to think that she don't see what I see" },
  { t: 44.5, duration: 7.0, text: "But every time she asks me, \"Do I look okay?\"\nI say‚Ä¶" },
  { t: 51.5, duration: 9.5, text: "When I see your face\nThere's not a thing that I would change" },
  { t: 61.0, duration: 9.0, text: "'Cause you're amazing\nJust the way you are" },
  { t: 70.0, duration: 8.0, text: "And when you smile\nThe whole world stops and stares for a while" },
  { t: 78.0, duration: 10.0, text: "'Cause girl, you're amazing\nJust the way you are" },
];


/* -------------- lyric UI and typing effect -------------- */
const lyricsDisplay = document.getElementById('lyricsDisplay');
const lyricLineEl = document.getElementById('lyricLine');
// separate lists for timeouts (scheduling) and intervals (typing)
let lyricTimeouts = [];
let lyricIntervals = [];

/**
 * Type a multi-line lyric text into the lyricLineEl.
 * duration: how long the line should take to completely type (ms) - we map this duration.
 */
function typeLyric(text, duration) {
  clearTyping();
  lyricLineEl.classList.remove('visible');
  lyricLineEl.innerHTML = ''; // clear content

  // convert newlines to markers, but we will reveal characters including newline
  const normalized = text.replace(/\r/g,'');
  const chars = Array.from(normalized); // supports unicode
  const interval = Math.max(10, Math.round(duration / Math.max(1, chars.length))); // ms per char

  let i = 0;
  const t = setInterval(() => {
    const ch = chars[i++];
    // keep newline as line break for HTML
    if (ch === '\n') lyricLineEl.innerHTML += '<br>';
    else lyricLineEl.innerHTML += ch.replace(/</g,'&lt;').replace(/>/g,'&gt;');

    if (i >= chars.length) {
      clearInterval(t);
    }
  }, interval);
  lyricIntervals.push(t);

  // ensure visible class added (fade)
  setTimeout(()=> lyricLineEl.classList.add('visible'), 60);
}

/* clears any active typing intervals */
function clearTyping() {
  lyricIntervals.forEach(tt => clearInterval(tt));
  lyricIntervals = [];
}

/* schedule lyrics relative to audio playback */
function scheduleLyrics(audio) {
  // clear existing scheduled timeouts and typing intervals
  lyricTimeouts.forEach(tt => clearTimeout(tt));
  lyricTimeouts = [];
  clearTyping();

  // show the lyrics display
  lyricsDisplay.style.visibility = 'visible';
  lyricLineEl.textContent = '';

  // use a stable wall-clock reference so scheduling works even if audio isn't ready.
  // If a playing audio is provided, align to its currentTime; otherwise start from now.
  const now = performance.now();
  const usingAudio = audio && !audio.paused && !isNaN(audio.currentTime);
  const baseTimeMs = usingAudio ? now - (audio.currentTime * 1000) : now;

  lyricsTimeline.forEach((entry, idx) => {
    // desired show time in ms since baseTimeMs
    const showAt = baseTimeMs + entry.t * 1000;
    const delay = Math.max(0, showAt - performance.now());

    // when showing, tag which entry is current so later hide timers don't clear newer text
    const showTimer = setTimeout(() => {
      lyricLineEl.dataset.currentEntry = String(idx);
      typeLyric(entry.text, Math.max(600, entry.duration * 800));
    }, delay);
    lyricTimeouts.push(showTimer);

    // schedule hide after the entry's duration, but only clear if this entry is still active
    const hideDelay = delay + (entry.duration * 1000) + 300;
    const hideTimer = setTimeout(() => {
      if (lyricLineEl.dataset.currentEntry === String(idx)) {
        lyricLineEl.classList.remove('visible');
        setTimeout(()=> {
          if (lyricLineEl.dataset.currentEntry === String(idx)) lyricLineEl.innerHTML = '';
        }, 260);
      }
    }, hideDelay);
    lyricTimeouts.push(hideTimer);
  });

  // hide entire lyrics some time after last line
  const last = lyricsTimeline[lyricsTimeline.length-1];
  const finalHideDelay = Math.max(0, (baseTimeMs + last.t*1000 + last.duration*1000 + 1000) - performance.now());
  const finalHide = setTimeout(() => {
    // only hide the whole lyrics panel if the last entry is still current (avoid racing)
    if (lyricLineEl.dataset.currentEntry === String(lyricsTimeline.length - 1)) {
      lyricLineEl.classList.remove('visible');
      setTimeout(()=> lyricsDisplay.style.visibility = 'hidden', 380);
    }
  }, finalHideDelay);
  lyricTimeouts.push(finalHide);
}

/* -------------- celebration visuals (music control + confetti/balloons/etc) -------------- */

let audioInstance = null;
function startCelebration(){
  // user clicked (good for autoplay)
  document.getElementById('celebrateBtn').style.display = 'none';
  document.getElementById('wishMessage').style.display = 'block';

  // audio instance (re-use if already)
  if (!audioInstance) {
    audioInstance = new Audio(AUDIO_SRC);
    audioInstance.preload = 'auto';
  }
  audioInstance.currentTime = 0;
  audioInstance.volume = 1;
  audioInstance.play().then(()=> {
    scheduleLyrics(audioInstance);
  }).catch(()=> {
    // fallback: listen to playing event
    audioInstance.addEventListener('playing', ()=> scheduleLyrics(audioInstance), { once:true });
  });

  // flash & big confetti burst
  quickFlash();
  confettiBurst(window.innerWidth/2, window.innerHeight/2, 120);

  // sparkle over greeting
  startSparkles();

  // start repeated smaller bursts + balloons + floating pics
  const duration = 11000;
  const interval = 350;
  let elapsed = 0;
  const id = setInterval(()=> {
    confettiSmallBurst();
    const count = window.innerWidth < 700 ? 1 : 2;
    for (let i=0;i<count;i++) createBalloon(Math.random()*(window.innerWidth-80));
    // spawn floating picture sparingly, keep max existing <= 3
    if (Math.random() < 0.35) createFloatingPicture();
    elapsed += interval;
    if (elapsed >= duration) clearInterval(id);
  }, interval);
}

/* quick flash */
function quickFlash(){
  flashEl.style.transition = 'opacity 160ms ease';
  flashEl.style.opacity = '0.92';
  setTimeout(()=> flashEl.style.opacity = '0', 200);
}

/* confetti burst helpers */
function confettiBurst(x=window.innerWidth/2, y=window.innerHeight/2, total=60){
  const colors = ['#f5576c','#f093fb','#4facfe','#00f2fe','#ffd700','#ff6b9d'];
  for (let i=0;i<total;i++){
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.left = x + 'px';
    c.style.top = y + 'px';
    const size = 6 + Math.random()*10;
    c.style.width = size + 'px';
    c.style.height = (size/(Math.random()*1.4 + 1)) + 'px';
    c.style.background = colors[Math.floor(Math.random()*colors.length)];
    document.body.appendChild(c);
    const angle = Math.random() * Math.PI * 2;
    const distance = 120 + Math.random()*360;
    const dx = Math.cos(angle)*distance;
    const dy = Math.sin(angle)*distance;
    c.animate([
      { transform: 'translate(0,0) rotate(0deg)', opacity:1 },
      { transform: `translate(${dx}px, ${dy}px) rotate(${720 + Math.random()*720}deg)`, opacity:0 }
    ], { duration: 700 + Math.random()*1000, easing:'cubic-bezier(.2,.6,.2,1)', fill:'forwards' });
    setTimeout(()=> c.remove(), 2200);
  }
}
function confettiSmallBurst(){
  const colors = ['#f5576c','#f093fb','#4facfe','#00f2fe','#ffd700','#ff6b9d'];
  for (let i=0;i<6;i++){
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.left = Math.random()*window.innerWidth + 'px';
    c.style.top = '-20px';
    const size = 6 + Math.random()*8;
    c.style.width = size + 'px';
    c.style.height = (size/(Math.random()*1.3 + 1)) + 'px';
    c.style.background = colors[Math.floor(Math.random()*colors.length)];
    document.body.appendChild(c);
    c.animate([
      { transform: 'translateY(0)', opacity:1 },
      { transform: `translateY(${window.innerHeight+200}px) rotate(${360 + Math.random()*360}deg)`, opacity:0 }
    ], { duration: 2400 + Math.random()*1200, easing:'linear', fill:'forwards' });
    setTimeout(()=> c.remove(), 4200);
  }
}

/* balloons with string */
function createBalloon(leftX){
  const colors = ['#FF6B6B','#4ECDC4','#FFE66D','#95E1D3','#F38181','#AA96DA'];
  const b = document.createElement('div');
  b.className = 'balloon';
  b.style.left = (leftX || Math.random()*(window.innerWidth-80)) + 'px';
  b.style.bottom = '-140px';
  b.style.background = colors[Math.floor(Math.random()*colors.length)];
  const s = document.createElement('div'); s.className='string';
  b.appendChild(s);
  document.body.appendChild(b);
  const deltaX = (Math.random()-0.5) * 220;
  const duration = 4200 + Math.random()*3800; // 4-8s
  b.animate([
    { transform: 'translate(0,0) rotate(0deg)' },
    { transform: `translate(${deltaX}px, -110vh) rotate(${(Math.random()*40-20)}deg)` }
  ], { duration: duration, easing:'cubic-bezier(.2,.6,.2,1)', fill:'forwards' });
  setTimeout(()=> b.remove(), duration + 120);
}

/* floating pictures (limit existing <= 3) */
const imagePaths = ['images/1.png' , 'images/2.png' , 'images/3.png' , 'images/4.png' , 'images/5.png']; // place your responsive images in images/ folder (relative)
function createFloatingPicture(){
  const existing = document.querySelectorAll('.floating-pic').length;
  if (existing >= 5) return;
  const pic = document.createElement('img');
  pic.className = 'floating-pic';
  // choose random image if available
  pic.src = imagePaths[Math.floor(Math.random()*imagePaths.length)];
  pic.style.left = Math.random()*(window.innerWidth - 140) + 'px';
  const size = Math.max(80, Math.min(180, 90 + Math.random()*100));
  pic.style.width = size + 'px'; pic.style.height = size + 'px';
  document.body.appendChild(pic);
  setTimeout(()=> pic.remove(), 8500);
}

/* sparkles over greeting */
let sparkleRef = null;
function startSparkles(){
  const greeting = document.getElementById('greetingText');
  if (sparkleRef) clearInterval(sparkleRef);
  sparkleRef = setInterval(()=> {
    const s = document.createElement('div');
    s.style.position = 'absolute';
    s.style.width = '6px'; s.style.height = '6px'; s.style.borderRadius='50%';
    s.style.background = '#fff'; s.style.boxShadow='0 0 8px #fff';
    const rect = greeting.getBoundingClientRect();
    // position relative to whole page, but roughly over heading
    s.style.left = (rect.left + Math.random()*rect.width) + 'px';
    s.style.top = (rect.top + Math.random()*rect.height) + 'px';
    s.style.zIndex = 1400;
    document.body.appendChild(s);
    setTimeout(()=> s.remove(), 900);
  }, 240);
}

/* -------------- lightweight fireworks canvas (transparent) -------------- */
const canvas = document.getElementById('fireworksCanvas');
const ctx = canvas.getContext('2d');
let cw, ch;
function resizeCanvas(){ cw = canvas.width = window.innerWidth; ch = canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

const fireworks = [], particles = [];
function rand(min,max){ return Math.random()*(max-min)+min; }

class Firework {
  constructor(x,y,tx,ty){ this.x=x; this.y=y; this.tx=tx; this.ty=ty; this.distance=Math.hypot(tx-x,ty-y); this.traveled=0; this.angle=Math.atan2(ty-y,tx-x); this.speed=5; this.accel=1.05; }
  update(){ const vx=Math.cos(this.angle)*this.speed, vy=Math.sin(this.angle)*this.speed; this.x+=vx; this.y+=vy; this.speed*=this.accel; this.traveled+=Math.hypot(vx,vy); if(this.traveled>=this.distance){ createParticles(this.tx,this.ty); return true;} return false; }
  draw(){ ctx.beginPath(); ctx.moveTo(this.x,this.y); ctx.lineTo(this.x-1,this.y-1); ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.stroke(); }
}

class Particle {
  constructor(x,y){ this.x=x; this.y=y; this.speed=rand(1,6); this.angle=rand(0,Math.PI*2); this.friction=0.95; this.gravity=0.7; this.alpha=1; this.decay=rand(0.015,0.03); this.color=`hsl(${Math.floor(rand(0,360))},100%,60%)`; }
  update(){ this.speed*=this.friction; this.x+=Math.cos(this.angle)*this.speed; this.y+=Math.sin(this.angle)*this.speed + this.gravity*0.5; this.alpha-=this.decay; }
  draw(){ ctx.globalAlpha=this.alpha; ctx.beginPath(); ctx.arc(this.x,this.y,2,0,Math.PI*2,false); ctx.fillStyle=this.color; ctx.fill(); ctx.globalAlpha=1; }
}

function createParticles(x,y){ for(let i=0;i<26;i++) particles.push(new Particle(x,y)); }

function animateFireworks(){
  requestAnimationFrame(animateFireworks);
  ctx.clearRect(0,0,cw,ch);
  for(let i=fireworks.length-1;i>=0;i--){ fireworks[i].draw(); if(fireworks[i].update()) fireworks.splice(i,1); }
  for(let i=particles.length-1;i>=0;i--){ particles[i].draw(); particles[i].update(); if(particles[i].alpha<=0) particles.splice(i,1); }
  if(Math.random() < 0.03) fireworks.push(new Firework(cw/2,ch,rand(100,cw-100), rand(50,ch/2)));
}
animateFireworks();

/* ----------------- Utilities & cleanup ----------------- */
window.addEventListener('visibilitychange', ()=> {
  if (document.hidden && audioInstance) audioInstance.pause();
});

/* Accessibility: keyboard open envelope */
envelope.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' || e.key === ' ') envelope.click();
});
envelope.tabIndex = 0;

</script>
</body>
</html>
